<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PelangiManager Error Handling Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { margin: 5px; padding: 8px 15px; cursor: pointer; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .debug-info { font-size: 12px; color: #6c757d; }
    </style>
</head>
<body>
    <h1>üß™ PelangiManager Enhanced Error Handling Test</h1>
    <div class="test-section info">
        <h3>üìã Test Instructions</h3>
        <p>This page tests the enhanced error handling system. Open browser console (F12) to see detailed logs.</p>
        <p><strong>Prerequisites:</strong> PelangiManager server must be running on localhost:5000</p>
    </div>

    <div class="test-section">
        <h3>üîê Authentication Error Tests (401)</h3>
        <button onclick="testAuthError()">Test Invalid Token</button>
        <div id="auth-result"></div>
    </div>

    <div class="test-section">
        <h3>‚úÖ Validation Error Tests (400)</h3>
        <button onclick="testValidationError()">Test Guest Token Validation</button>
        <button onclick="testCheckinValidation()">Test Check-in Validation</button>
        <div id="validation-result"></div>
    </div>

    <div class="test-section">
        <h3>üåê Network Error Tests</h3>
        <button onclick="testNetworkError()">Test Connection Failed</button>
        <div id="network-result"></div>
    </div>

    <div class="test-section">
        <h3>üîç 404 Error Tests</h3>
        <button onclick="test404Error()">Test Endpoint Not Found</button>
        <div id="notfound-result"></div>
    </div>

    <div class="test-section">
        <h3>üéØ Frontend Error Handler Tests</h3>
        <button onclick="testErrorParsing()">Test Error Parsing</button>
        <button onclick="testToastCreation()">Test Toast Creation</button>
        <div id="handler-result"></div>
    </div>

    <div class="test-section">
        <h3>üì± Debug Information Test</h3>
        <button onclick="testDebugInfo()">Test Debug Info (Dev Mode)</button>
        <div id="debug-result"></div>
    </div>

    <script>
        console.log('üöÄ Error Handling Test Page Loaded');
        
        // Mock error handler functions (simplified versions)
        const ErrorHandler = {
            async parseApiError(error, endpoint, method, requestData) {
                const timestamp = new Date().toISOString();
                const userAgent = navigator.userAgent;
                const url = window.location.href;

                let detailedError = {
                    message: "Unknown error occurred",
                    endpoint,
                    debugInfo: {
                        timestamp,
                        userAgent,
                        url,
                        method,
                        requestData,
                    }
                };

                if (error instanceof Response) {
                    detailedError.statusCode = error.status;
                    
                    try {
                        const responseText = await error.text();
                        let responseData = responseText;
                        
                        try {
                            responseData = JSON.parse(responseText);
                        } catch {
                            // Response is not JSON, keep as text
                        }
                        
                        detailedError.debugInfo.responseData = responseData;
                        
                        if (typeof responseData === 'object' && responseData.message) {
                            detailedError.message = responseData.message;
                            detailedError.details = responseData.details || responseData.errors;
                        } else {
                            detailedError.message = responseText || error.statusText || `HTTP ${error.status} Error`;
                        }
                    } catch {
                        detailedError.message = error.statusText || `HTTP ${error.status} Error`;
                    }
                } else if (error instanceof Error) {
                    detailedError.message = error.message;
                }

                // Enhance with contextual information
                return this.enhanceErrorWithContext(detailedError);
            },

            enhanceErrorWithContext(error) {
                const enhanced = { ...error };

                switch (enhanced.statusCode) {
                    case 401:
                        enhanced.message = "Authentication Required";
                        enhanced.details = "Your session has expired or you're not logged in.";
                        enhanced.solution = "Please log in again to continue.";
                        enhanced.errorCode = "AUTH_REQUIRED";
                        break;
                        
                    case 400:
                        enhanced.message = "Validation Error";
                        enhanced.details = "The submitted data failed server validation.";
                        enhanced.solution = "Please check your input and try again.";
                        enhanced.errorCode = "VALIDATION_ERROR";
                        break;
                        
                    case 404:
                        enhanced.message = "Endpoint Not Found";
                        enhanced.details = `The API endpoint ${enhanced.endpoint} was not found on the server.`;
                        enhanced.solution = "This might be a temporary server issue. Try refreshing the page.";
                        enhanced.errorCode = "ENDPOINT_NOT_FOUND";
                        break;
                        
                    default:
                        if (enhanced.message.includes('Failed to fetch') || enhanced.message.includes('NetworkError')) {
                            enhanced.message = "Connection Failed";
                            enhanced.details = "Unable to connect to the server.";
                            enhanced.solution = "Check your internet connection and ensure the server is running.";
                            enhanced.errorCode = "CONNECTION_FAILED";
                        }
                        break;
                }

                return enhanced;
            },

            createErrorToast(error) {
                let description = error.message;
                
                if (error.details) {
                    description += `\\n\\nDetails: ${typeof error.details === 'object' ? JSON.stringify(error.details, null, 2) : error.details}`;
                }
                
                if (error.solution) {
                    description += `\\n\\nSolution: ${error.solution}`;
                }

                let debugDetails = "";
                if (error.debugInfo) {
                    debugDetails = `Debug Info:
‚Ä¢ Timestamp: ${error.debugInfo.timestamp}
‚Ä¢ Endpoint: ${error.endpoint || 'Unknown'}
‚Ä¢ Status: ${error.statusCode || 'Unknown'}
‚Ä¢ Error Code: ${error.errorCode || 'Unknown'}`;

                    if (error.debugInfo.method && error.debugInfo.requestData) {
                        debugDetails += `
‚Ä¢ Request: ${error.debugInfo.method} ${error.endpoint}
‚Ä¢ Data: ${JSON.stringify(error.debugInfo.requestData, null, 2)}`;
                    }
                }

                return {
                    title: error.statusCode === 401 ? "Authentication Required" : "Operation Failed",
                    description,
                    variant: "destructive",
                    debugDetails,
                };
            }
        };

        // Test functions
        async function testAuthError() {
            console.log('üîê Testing Authentication Error...');
            const resultDiv = document.getElementById('auth-result');
            
            try {
                const response = await fetch('/api/guest-tokens', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer invalid-token-12345',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        capsuleNumber: 'C01',
                        expiresIn: 2
                    }),
                    credentials: 'include'
                });
                
                console.log('Response status:', response.status);
                
                if (response.status === 401) {
                    const detailedError = await ErrorHandler.parseApiError(response, '/api/guest-tokens', 'POST', {
                        capsuleNumber: 'C01',
                        expiresIn: 2
                    });
                    
                    const toast = ErrorHandler.createErrorToast(detailedError);
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Authentication Error Test Passed</h4>
                            <p><strong>Status:</strong> ${response.status}</p>
                            <p><strong>Enhanced Message:</strong> ${detailedError.message}</p>
                            <p><strong>Solution:</strong> ${detailedError.solution}</p>
                            <p><strong>Error Code:</strong> ${detailedError.errorCode}</p>
                            <details>
                                <summary>Toast Preview</summary>
                                <pre>${JSON.stringify(toast, null, 2)}</pre>
                            </details>
                            <details>
                                <summary>Debug Information</summary>
                                <pre class="debug-info">${toast.debugDetails || 'No debug info'}</pre>
                            </details>
                        </div>
                    `;
                    
                    console.log('‚úÖ Detailed error:', detailedError);
                    console.log('‚úÖ Toast created:', toast);
                }
            } catch (error) {
                console.error('‚ùå Test failed:', error);
                resultDiv.innerHTML = `<div class="error">‚ùå Test failed: ${error.message}</div>`;
            }
        }

        async function testValidationError() {
            console.log('‚úÖ Testing Validation Error...');
            const resultDiv = document.getElementById('validation-result');
            
            try {
                // Get a valid token first
                const authResponse = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@pelangi.com',
                        password: 'admin123'
                    })
                });
                
                const authData = await authResponse.json();
                const token = authData.token;
                
                const response = await fetch('/api/guest-tokens', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        capsuleNumber: '',  // Invalid empty capsule
                        expiresIn: -1      // Invalid negative expiration
                    }),
                    credentials: 'include'
                });
                
                console.log('Validation response status:', response.status);
                
                if (response.status === 400) {
                    const detailedError = await ErrorHandler.parseApiError(response, '/api/guest-tokens', 'POST', {
                        capsuleNumber: '',
                        expiresIn: -1
                    });
                    
                    const toast = ErrorHandler.createErrorToast(detailedError);
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Validation Error Test Passed</h4>
                            <p><strong>Status:</strong> ${response.status}</p>
                            <p><strong>Enhanced Message:</strong> ${detailedError.message}</p>
                            <p><strong>Solution:</strong> ${detailedError.solution}</p>
                            <details>
                                <summary>Validation Details</summary>
                                <pre>${JSON.stringify(detailedError.details, null, 2)}</pre>
                            </details>
                            <details>
                                <summary>Toast Preview</summary>
                                <pre>${JSON.stringify(toast, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                    
                    console.log('‚úÖ Validation error:', detailedError);
                }
            } catch (error) {
                console.error('‚ùå Validation test failed:', error);
                resultDiv.innerHTML = `<div class="error">‚ùå Test failed: ${error.message}</div>`;
            }
        }

        async function testNetworkError() {
            console.log('üåê Testing Network Error...');
            const resultDiv = document.getElementById('network-result');
            
            try {
                // Try to connect to non-existent port
                await fetch('http://localhost:9999/api/test');
                resultDiv.innerHTML = `<div class="error">‚ùå Network test failed - should have thrown error</div>`;
            } catch (error) {
                const detailedError = await ErrorHandler.parseApiError(error, 'http://localhost:9999/api/test', 'GET');
                const toast = ErrorHandler.createErrorToast(detailedError);
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Network Error Test Passed</h4>
                        <p><strong>Error Type:</strong> ${error.constructor.name}</p>
                        <p><strong>Enhanced Message:</strong> ${detailedError.message}</p>
                        <p><strong>Solution:</strong> ${detailedError.solution}</p>
                        <p><strong>Error Code:</strong> ${detailedError.errorCode}</p>
                        <details>
                            <summary>Toast Preview</summary>
                            <pre>${JSON.stringify(toast, null, 2)}</pre>
                        </details>
                    </div>
                `;
                
                console.log('‚úÖ Network error handled:', detailedError);
            }
        }

        async function test404Error() {
            console.log('üîç Testing 404 Error...');
            const resultDiv = document.getElementById('notfound-result');
            
            try {
                const response = await fetch('/api/non-existent-endpoint-test');
                
                if (response.status === 404) {
                    const detailedError = await ErrorHandler.parseApiError(response, '/api/non-existent-endpoint-test', 'GET');
                    const toast = ErrorHandler.createErrorToast(detailedError);
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ 404 Error Test Passed</h4>
                            <p><strong>Status:</strong> ${response.status}</p>
                            <p><strong>Enhanced Message:</strong> ${detailedError.message}</p>
                            <p><strong>Details:</strong> ${detailedError.details}</p>
                            <p><strong>Solution:</strong> ${detailedError.solution}</p>
                            <details>
                                <summary>Toast Preview</summary>
                                <pre>${JSON.stringify(toast, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                    
                    console.log('‚úÖ 404 error handled:', detailedError);
                }
            } catch (error) {
                console.error('‚ùå 404 test failed:', error);
                resultDiv.innerHTML = `<div class="error">‚ùå Test failed: ${error.message}</div>`;
            }
        }

        async function testErrorParsing() {
            console.log('üéØ Testing Error Parsing...');
            const resultDiv = document.getElementById('handler-result');
            
            // Test different error types
            const testCases = [
                {
                    name: 'Response Object',
                    error: new Response('{"message": "Test error", "details": "Test details"}', {
                        status: 422,
                        statusText: 'Unprocessable Entity'
                    })
                },
                {
                    name: 'Error Object',
                    error: new Error('Network request failed')
                },
                {
                    name: 'String Error',
                    error: 'Simple string error'
                }
            ];
            
            let results = '<h4>Error Parsing Test Results:</h4>';
            
            for (const testCase of testCases) {
                try {
                    const detailedError = await ErrorHandler.parseApiError(testCase.error, '/api/test', 'POST', { test: 'data' });
                    const toast = ErrorHandler.createErrorToast(detailedError);
                    
                    results += `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 3px;">
                            <h5>‚úÖ ${testCase.name}</h5>
                            <p><strong>Message:</strong> ${detailedError.message}</p>
                            <p><strong>Status:</strong> ${detailedError.statusCode || 'N/A'}</p>
                            <p><strong>Error Code:</strong> ${detailedError.errorCode || 'N/A'}</p>
                            <details>
                                <summary>Full Details</summary>
                                <pre>${JSON.stringify(detailedError, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } catch (error) {
                    results += `<div class="error">‚ùå ${testCase.name} failed: ${error.message}</div>`;
                }
            }
            
            resultDiv.innerHTML = `<div class="success">${results}</div>`;
        }

        async function testDebugInfo() {
            console.log('üì± Testing Debug Information...');
            const resultDiv = document.getElementById('debug-result');
            
            const mockError = {
                message: 'Test error with debug info',
                statusCode: 500,
                errorCode: 'TEST_ERROR',
                endpoint: '/api/test',
                debugInfo: {
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    url: window.location.href,
                    method: 'POST',
                    requestData: { test: 'data', user: 'admin' },
                    responseData: { error: 'Server internal error', code: 500 }
                }
            };
            
            const toast = ErrorHandler.createErrorToast(mockError);
            
            resultDiv.innerHTML = `
                <div class="success">
                    <h4>‚úÖ Debug Information Test</h4>
                    <p><strong>Toast Title:</strong> ${toast.title}</p>
                    <p><strong>Has Debug Info:</strong> ${toast.debugDetails ? 'Yes ‚úÖ' : 'No ‚ùå'}</p>
                    <details>
                        <summary>Debug Information</summary>
                        <pre class="debug-info">${toast.debugDetails || 'No debug info available'}</pre>
                    </details>
                    <details>
                        <summary>Full Toast Object</summary>
                        <pre>${JSON.stringify(toast, null, 2)}</pre>
                    </details>
                </div>
            `;
            
            console.log('‚úÖ Debug info test:', toast);
        }

        // Run all tests on page load
        window.addEventListener('load', () => {
            console.log('üöÄ Error Handling Test Page Ready');
            console.log('Click the test buttons to run individual tests');
        });
    </script>
</body>
</html>